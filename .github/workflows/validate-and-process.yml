name: Validate and Process EvalAI Challenge

on:
  push:
    branches:
      - challenge

permissions:
  contents: read
  issues: write

jobs:
  validate-host-config:
    runs-on: ubuntu-latest
    outputs:
      is_valid: ${{ steps.validate.outputs.is_valid }}
      is_localhost: ${{ steps.validate.outputs.is_localhost }}
      host_url: ${{ steps.validate.outputs.host_url }}
      requires_self_hosted: ${{ steps.validate.outputs.requires_self_hosted }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Validate host_config.json
        id: validate
        run: |
          echo "is_valid=true" >> $GITHUB_OUTPUT
          echo "is_localhost=false" >> $GITHUB_OUTPUT
          echo "requires_self_hosted=false" >> $GITHUB_OUTPUT
          echo "" > validation_error.log

          if ! [ -f "github/host_config.json" ]; then
            echo "‚ùå host_config.json not found in github/ directory" | tee -a validation_error.log
            echo "is_valid=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          TOKEN=$(jq -r '.token' github/host_config.json)
          TEAM_PK=$(jq -r '.team_pk' github/host_config.json)
          HOST_URL=$(jq -r '.evalai_host_url' github/host_config.json)

          echo "host_url=$HOST_URL" >> $GITHUB_OUTPUT

          # Enhanced localhost detection
          if [[ "$HOST_URL" == *"127.0.0.1"* ]] || [[ "$HOST_URL" == *"localhost"* ]] || [[ "$HOST_URL" == *"0.0.0.0"* ]]; then
            echo "is_localhost=true" >> $GITHUB_OUTPUT
            echo "requires_self_hosted=true" >> $GITHUB_OUTPUT
            echo "üè† Localhost server detected: $HOST_URL"
            echo "ü§ñ Self-hosted runner required for local development"
            echo ""
            echo "üìã Requirements for local challenge creation:"
            echo "   ‚úÖ Self-hosted GitHub Actions runner must be configured"
            echo "   ‚úÖ EvalAI server must be running at: $HOST_URL"
            echo "   ‚úÖ Network connectivity between runner and server"
            echo ""
            echo "‚ö†Ô∏è  Note: GitHub hosted runners cannot connect to localhost"
            echo "‚ö†Ô∏è  This workflow will use your self-hosted runner instead"
          fi

          # Validate required fields
          if [[ -z "$TOKEN" || "$TOKEN" == "<evalai_user_auth_token>" ]]; then
            echo "‚ùå Invalid or missing token in host_config.json" | tee -a validation_error.log
            echo "üí° Please replace <evalai_user_auth_token> with your actual EvalAI token" | tee -a validation_error.log
            echo "is_valid=false" >> $GITHUB_OUTPUT
          fi

          if [[ -z "$TEAM_PK" || "$TEAM_PK" == "<host_team_pk>" ]]; then
            echo "‚ùå Invalid or missing team_pk in host_config.json" | tee -a validation_error.log
            echo "üí° Please replace <host_team_pk> with your actual team primary key" | tee -a validation_error.log
            echo "is_valid=false" >> $GITHUB_OUTPUT
          fi

          if [[ -z "$HOST_URL" || "$HOST_URL" == "<evalai_host_url>" ]]; then
            echo "‚ùå Invalid or missing evalai_host_url in host_config.json" | tee -a validation_error.log
            echo "üí° Please replace <evalai_host_url> with your EvalAI server URL" | tee -a validation_error.log
            echo "is_valid=false" >> $GITHUB_OUTPUT
          fi

      - name: Create issue if invalid
        if: steps.validate.outputs.is_valid == 'false'
        uses: peter-evans/create-issue-from-file@v4
        with:
          title: "‚ùå host_config.json validation failed"
          content-filepath: validation_error.log
          labels: |
            bug
            config
            self-hosted

      - name: Fail job if invalid
        if: steps.validate.outputs.is_valid == 'false'
        run: |
          echo "‚ùå host_config.json validation failed. See issue for details."
          exit 1

  check-self-hosted-requirements:
    needs: validate-host-config
    if: needs.validate-host-config.outputs.requires_self_hosted == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Self-hosted runner requirements check
        run: |
          echo "üè† LOCAL DEVELOPMENT MODE DETECTED"
          echo "=================================="
          echo ""
          echo "üìã To proceed with local challenge creation, ensure you have:"
          echo ""
          echo "1Ô∏è‚É£  Self-hosted GitHub Actions runner configured:"
          echo "   ‚Ä¢ Download runner from: https://github.com/${{ github.repository }}/settings/actions/runners"
          echo "   ‚Ä¢ Install and configure on your local machine"
          echo "   ‚Ä¢ Start the runner service"
          echo ""
          echo "2Ô∏è‚É£  Docker installed and running:"
          echo "   ‚Ä¢ Docker Engine must be available on the runner machine"
          echo "   ‚Ä¢ Will use 'docker run' commands with python:3.9-slim (architecture independent)"
          echo "   ‚Ä¢ This solves compatibility issues with ARM64/macOS architectures"
          echo "   ‚Ä¢ Note: GitHub Actions containers only work on Linux, so we use docker run instead"
          echo ""
          echo "3Ô∏è‚É£  EvalAI server running locally:"
          echo "   ‚Ä¢ Server URL: ${{ needs.validate-host-config.outputs.host_url }}"
          echo "   ‚Ä¢ Ensure it's accessible from Docker containers (use host networking)"
          echo "   ‚Ä¢ Verify API endpoints are responding"
          echo ""
          echo "4Ô∏è‚É£  Network connectivity:"
          echo "   ‚Ä¢ Docker container can reach your EvalAI server"
          echo "   ‚Ä¢ No firewall blocking connections"
          echo "   ‚Ä¢ Consider using host.docker.internal for macOS/Windows"
          echo ""
          echo "‚ö†Ô∏è  This job will continue on your self-hosted runner with Docker..."
          echo "‚ö†Ô∏è  If you don't have a self-hosted runner with Docker, the next job will fail"

  process-evalai-challenge:
    needs: [validate-host-config, check-self-hosted-requirements]
    if: |
      always() && 
      needs.validate-host-config.outputs.is_valid == 'true' &&
      (needs.check-self-hosted-requirements.result == 'success' || needs.check-self-hosted-requirements.result == 'skipped')
    runs-on: ${{ needs.validate-host-config.outputs.requires_self_hosted == 'true' && 'self-hosted' || 'ubuntu-latest' }}
    
    # Note: GitHub Actions containers only work on Linux runners
    # For macOS self-hosted runners, we'll use Docker run commands instead
    
    steps:
      - name: Checkout challenge branch
        uses: actions/checkout@v3
        with:
          ref: challenge

      - name: Environment Information
        run: |
          echo "üîç ENVIRONMENT INFORMATION"
          echo "========================="
          echo "Runner Type: ${{ needs.validate-host-config.outputs.requires_self_hosted == 'true' && 'Self-hosted (macOS + Docker)' || 'GitHub-hosted' }}"
          echo "EvalAI URL: ${{ needs.validate-host-config.outputs.host_url }}"
          echo "Is Localhost: ${{ needs.validate-host-config.outputs.is_localhost }}"
          echo "OS: $(uname -s)"
          echo "Architecture: $(uname -m)"
          echo "Working Directory: $(pwd)"
          if [[ "${{ needs.validate-host-config.outputs.requires_self_hosted }}" == "true" ]]; then
            echo "Docker Version: $(docker --version)"
            echo "Will use Docker containers for Python execution"
          else
            echo "Python Version: $(python3 --version)"
          fi
          echo ""

      - name: Set up Python (GitHub-hosted only)
        if: needs.validate-host-config.outputs.requires_self_hosted != 'true'
        uses: actions/setup-python@v4
        with:
          python-version: 3.9.21

      - name: Prepare Docker environment (Self-hosted only)
        if: needs.validate-host-config.outputs.requires_self_hosted == 'true'
        run: |
          echo "üê≥ PREPARING DOCKER ENVIRONMENT"
          echo "==============================="
          echo "Pulling Python 3.9 Docker image..."
          docker pull python:3.9-slim
          echo "‚úÖ Docker image ready"

      - name: Install dependencies (GitHub-hosted)
        if: needs.validate-host-config.outputs.requires_self_hosted != 'true'
        run: |
          python -m pip install --upgrade pip
          if [ -f github/requirements.txt ]; then 
            echo "üì¶ Installing dependencies from github/requirements.txt"
            pip install -r github/requirements.txt
          else
            echo "‚ö†Ô∏è  No requirements.txt found in github/ directory"
          fi

      - name: Install dependencies (Self-hosted with Docker)
        if: needs.validate-host-config.outputs.requires_self_hosted == 'true'
        run: |
          echo "üì¶ Installing dependencies in Docker container"
          docker run --rm -v "$(pwd):/workspace" -w /workspace python:3.9-slim bash -c "
            pip install --upgrade pip
            if [ -f github/requirements.txt ]; then 
              echo 'üì¶ Installing dependencies from github/requirements.txt'
              pip install -r github/requirements.txt
            else
              echo '‚ö†Ô∏è  No requirements.txt found in github/ directory'
            fi
          "
          echo "‚úÖ Dependencies installed in Docker"

      - name: Pre-flight Local Server Health Check (GitHub-hosted)
        if: needs.validate-host-config.outputs.is_localhost == 'true' && needs.validate-host-config.outputs.requires_self_hosted != 'true'
        run: |
          echo "üè• LOCAL SERVER HEALTH CHECK"
          echo "============================"
          
          SERVER_URL="${{ needs.validate-host-config.outputs.host_url }}"
          echo "üîç Checking EvalAI server at: $SERVER_URL"
          
          # Health check logic for GitHub-hosted runners
          # (This would typically not be used since GitHub-hosted can't reach localhost)
          curl -s --connect-timeout 10 --max-time 10 "$SERVER_URL/" > /dev/null 2>&1 || {
            echo "‚ùå Cannot reach EvalAI server"
            exit 1
          }
          echo "‚úÖ Health check passed"

      - name: Pre-flight Local Server Health Check (Self-hosted with Docker)
        if: needs.validate-host-config.outputs.is_localhost == 'true' && needs.validate-host-config.outputs.requires_self_hosted == 'true'
        run: |
          echo "üè• LOCAL SERVER HEALTH CHECK (Docker Container)"
          echo "==============================================="
          
          SERVER_URL="${{ needs.validate-host-config.outputs.host_url }}"
          echo "üîç Checking EvalAI server at: $SERVER_URL"
          echo "üê≥ Running health check from Docker container"
          echo ""
          
          # Extract host and port from URL
          if [[ "$SERVER_URL" =~ http://([^:/]+):([0-9]+) ]]; then
            HOST="${BASH_REMATCH[1]}"
            PORT="${BASH_REMATCH[2]}"
          elif [[ "$SERVER_URL" =~ http://([^:/]+) ]]; then
            HOST="${BASH_REMATCH[1]}"
            PORT="80"
          else
            echo "‚ùå Unable to parse server URL: $SERVER_URL"
            exit 1
          fi
          
          echo "üåê Resolved to Host: $HOST, Port: $PORT"
          
          # Try different host variations for Docker networking
          HOSTS_TO_TRY=("$HOST")
          if [[ "$HOST" == "localhost" || "$HOST" == "127.0.0.1" ]]; then
            HOSTS_TO_TRY+=("host.docker.internal" "172.17.0.1")
            echo "üîÑ Will try multiple host variants for Docker networking:"
            printf '   ‚Ä¢ %s\n' "${HOSTS_TO_TRY[@]}"
          fi
          echo ""
          
          # Test basic connectivity with multiple host variants using Docker
          echo "1Ô∏è‚É£  Testing basic connectivity from Docker container..."
          CONNECTIVITY_SUCCESS=false
          WORKING_HOST=""
          
          for TEST_HOST in "${HOSTS_TO_TRY[@]}"; do
            echo "   üîç Testing connection to $TEST_HOST:$PORT..."
            if docker run --rm alpine/curl:latest sh -c "nc -z $TEST_HOST $PORT" 2>/dev/null; then
              echo "   ‚úÖ Port $PORT is reachable on $TEST_HOST"
              CONNECTIVITY_SUCCESS=true
              WORKING_HOST="$TEST_HOST"
              break
            else
              echo "   ‚ùå Port $PORT is NOT reachable on $TEST_HOST"
            fi
          done
          
          if [[ "$CONNECTIVITY_SUCCESS" != "true" ]]; then
            echo "   üí• Unable to connect to EvalAI server on any host variant"
            echo "   üí° Make sure your EvalAI server is running and accessible from Docker"
            echo ""
            echo "üö® DOCKER NETWORKING TROUBLESHOOTING:"
            echo "   1. If running EvalAI locally, use: python manage.py runserver 0.0.0.0:8888"
            echo "   2. Update host_config.json to use one of these URLs:"
            printf "      ‚Ä¢ http://host.docker.internal:%s (macOS/Windows)\n" "$PORT"
            printf "      ‚Ä¢ http://172.17.0.1:%s (Linux Docker bridge)\n" "$PORT"
            printf "      ‚Ä¢ http://0.0.0.0:%s (if server binds to all interfaces)\n" "$PORT"
            echo "   3. Ensure Docker can access host network"
            echo "   4. Check firewall settings"
            exit 1
          fi
          
          # Update SERVER_URL to use working host
          if [[ "$WORKING_HOST" != "$HOST" ]]; then
            SERVER_URL="http://$WORKING_HOST:$PORT"
            echo "   üîÑ Updated server URL to: $SERVER_URL"
          fi
          
          # Test HTTP endpoint using Docker
          echo ""
          echo "2Ô∏è‚É£  Testing HTTP endpoint from Docker container..."
          if docker run --rm alpine/curl:latest curl -s --connect-timeout 10 --max-time 10 "$SERVER_URL/" > /dev/null 2>&1; then
            echo "   ‚úÖ HTTP endpoint is responding at $SERVER_URL"
            
            # Test API endpoint
            echo ""
            echo "3Ô∏è‚É£  Testing API endpoint from Docker container..."
            API_URL="$SERVER_URL/api/"
            if docker run --rm alpine/curl:latest curl -s --connect-timeout 10 --max-time 10 "$API_URL" > /dev/null 2>&1; then
              echo "   ‚úÖ API endpoint is accessible at $API_URL"
            else
              echo "   ‚ö†Ô∏è  API endpoint test failed, but server is responding"
              echo "   üí° This might be normal if API requires authentication"
            fi
          else
            echo "   ‚ùå HTTP endpoint is not responding at $SERVER_URL"
            echo ""
            echo "üö® TROUBLESHOOTING STEPS:"
            echo "   1. Verify your EvalAI server is running:"
            echo "      python manage.py runserver 0.0.0.0:8888"
            echo "   2. Check if the server is binding to the correct interface (0.0.0.0)"
            echo "   3. Update host_config.json with Docker-compatible URL"
            echo "   4. Check server logs for errors"
            echo ""
            echo "   Docker networking tips:"
            echo "   ‚Ä¢ Use host.docker.internal instead of localhost on macOS/Windows"
            echo "   ‚Ä¢ Use 172.17.0.1 (Docker bridge IP) on Linux"
            echo "   ‚Ä¢ Ensure server binds to 0.0.0.0, not just 127.0.0.1"
            echo ""
            exit 1
          fi
          
          echo ""
          echo "‚úÖ Pre-flight health check completed successfully!"

      - name: Validate challenge configuration (GitHub-hosted)
        if: needs.validate-host-config.outputs.requires_self_hosted != 'true'
        run: |
          echo "üîç VALIDATING CHALLENGE CONFIGURATION"
          echo "====================================="
          python3 github/challenge_processing_script.py
        env:
          IS_VALIDATION: 'True'
          GITHUB_CONTEXT: ${{ toJson(github) }}
          GITHUB_AUTH_TOKEN: ${{ secrets.AUTH_TOKEN }}

      - name: Validate challenge configuration (Self-hosted with Docker)
        if: needs.validate-host-config.outputs.requires_self_hosted == 'true'
        run: |
          echo "üîç VALIDATING CHALLENGE CONFIGURATION (Docker)"
          echo "==============================================="
          docker run --rm \
            -v "$(pwd):/workspace" \
            -w /workspace \
            -e IS_VALIDATION='True' \
            -e GITHUB_CONTEXT='${{ toJson(github) }}' \
            -e GITHUB_AUTH_TOKEN='${{ secrets.AUTH_TOKEN }}' \
            python:3.9-slim \
            bash -c "
              pip install -r github/requirements.txt && 
              python3 github/challenge_processing_script.py
            "

      - name: Create or update challenge (GitHub-hosted)
        if: success() && needs.validate-host-config.outputs.requires_self_hosted != 'true'
        run: |
          echo "üöÄ CREATING/UPDATING CHALLENGE"
          echo "=============================="
          python3 github/challenge_processing_script.py
        env:
          IS_VALIDATION: 'False'
          GITHUB_CONTEXT: ${{ toJson(github) }}
          GITHUB_AUTH_TOKEN: ${{ secrets.AUTH_TOKEN }}

      - name: Create or update challenge (Self-hosted with Docker)
        if: success() && needs.validate-host-config.outputs.requires_self_hosted == 'true'
        run: |
          echo "üöÄ CREATING/UPDATING CHALLENGE (Docker)"
          echo "========================================"
          docker run --rm \
            -v "$(pwd):/workspace" \
            -w /workspace \
            -e IS_VALIDATION='False' \
            -e GITHUB_CONTEXT='${{ toJson(github) }}' \
            -e GITHUB_AUTH_TOKEN='${{ secrets.AUTH_TOKEN }}' \
            python:3.9-slim \
            bash -c "
              pip install -r github/requirements.txt && 
              python3 github/challenge_processing_script.py
            "

      - name: Success Summary
        if: success()
        run: |
          echo ""
          echo "üéâ CHALLENGE PROCESSING COMPLETED SUCCESSFULLY!"
          echo "=============================================="
          echo ""
          if [[ "${{ needs.validate-host-config.outputs.is_localhost }}" == "true" ]]; then
            echo "‚úÖ Local development mode: Challenge processed on self-hosted runner"
            echo "‚úÖ Docker containers: python:3.9-slim (architecture independent)"
            echo "‚úÖ macOS + Docker approach: Works on ARM64 and AMD64 architectures"
            echo "‚úÖ EvalAI server: ${{ needs.validate-host-config.outputs.host_url }}"
            echo "‚úÖ Self-hosted runner successfully connected to local server via Docker"
          else
            echo "‚úÖ Production mode: Challenge processed on GitHub-hosted runner"
            echo "‚úÖ EvalAI server: ${{ needs.validate-host-config.outputs.host_url }}"
          fi
          echo ""
          echo "üîç Check your EvalAI instance for the updated challenge configuration"

      - name: Failure Summary
        if: failure()
        run: |
          echo ""
          echo "‚ùå CHALLENGE PROCESSING FAILED"
          echo "=============================="
          echo ""
          if [[ "${{ needs.validate-host-config.outputs.is_localhost }}" == "true" ]]; then
            echo "üè† Local development mode detected (macOS + Docker)"
            echo "üí° Common issues for self-hosted runners with Docker:"
            echo "   ‚Ä¢ EvalAI server not running or not accessible from Docker containers"
            echo "   ‚Ä¢ Self-hosted runner not properly configured"
            echo "   ‚Ä¢ Docker not installed or not running on the runner machine"
            echo "   ‚Ä¢ Docker networking issues between container and host"
            echo "   ‚Ä¢ Need to use host.docker.internal instead of localhost in host_config.json"
            echo "   ‚Ä¢ Invalid authentication credentials"
            echo ""
            echo "üîß Quick fixes to try:"
            echo "   ‚Ä¢ Update host_config.json URL to: http://host.docker.internal:8888"
            echo "   ‚Ä¢ Ensure EvalAI server runs with: python manage.py runserver 0.0.0.0:8888"
            echo "   ‚Ä¢ Check Docker is running: docker --version"
            echo ""
            echo "üîç Check the logs above for specific error details"
          else
            echo "‚òÅÔ∏è  GitHub-hosted runner mode"
            echo "üîç Check the logs above for specific error details"
          fi
